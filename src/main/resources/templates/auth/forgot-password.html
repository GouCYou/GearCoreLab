<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>忘记密码 | CCTStudio - GearCoreLab</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" th:href="@{/css/main.css}">
</head>
<body>
    <div th:replace="fragments/header :: siteHeader('auth')"></div>

    <div class="auth-card fade-in">
        <h1>忘记密码</h1>
        <p style="color: var(--gray-500); margin-bottom: 1.5rem; font-size: 0.9rem;">请输入您的邮箱地址，我们将发送验证码到您的邮箱</p>
        
        <div th:if="${error}" style="background: #fee; color: #c33; padding: 0.75rem; border-radius: var(--radius); margin-bottom: 1rem; border: 1px solid #fcc;">
            <span th:text="${error}"></span>
        </div>
        
        <div th:if="${success}" style="background: #efe; color: #363; padding: 0.75rem; border-radius: var(--radius); margin-bottom: 1rem; border: 1px solid #cfc;">
            <span th:text="${success}"></span>
        </div>
        
        <form th:action="@{/forgot-password}" method="post">
            <input type="email" name="email" placeholder="邮箱地址" required>
            <button type="submit" class="submit-btn">发送验证码</button>
        </form>
        
        <div class="tips">
            <button id="resendBtn" onclick="resendCode()" style="background: none; border: none; color: #007bff; text-decoration: underline; cursor: pointer; margin-right: 15px; display: none;">重新发送验证码</button>
            <a th:href="@{/login}">返回登录</a>
        </div>
    </div>
    
    <script>
        let countdown = 0;
        let timer = null;
        let emailSent = false;
        
        function startCountdown() {
            countdown = 120;
            const resendBtn = document.getElementById('resendBtn');
            resendBtn.style.display = 'inline';
            resendBtn.disabled = true;
            resendBtn.style.color = '#6c757d';
            resendBtn.style.cursor = 'not-allowed';
            
            timer = setInterval(() => {
                resendBtn.textContent = `重新发送验证码 (${countdown}s)`;
                countdown--;
                
                if (countdown < 0) {
                    clearInterval(timer);
                    resendBtn.disabled = false;
                    resendBtn.style.color = '#007bff';
                    resendBtn.style.cursor = 'pointer';
                    resendBtn.textContent = '重新发送验证码';
                }
            }, 1000);
        }
        
        function resendCode() {
            if (countdown > 0) return;
            
            const email = document.querySelector('input[name="email"]').value;
            if (!email) {
                alert('请先输入邮箱地址');
                return;
            }
            
            fetch('/forgot-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'email=' + encodeURIComponent(email)
            })
            .then(response => {
                if (response.ok) {
                    alert('验证码已重新发送到您的邮箱');
                    startCountdown();
                } else {
                    alert('发送失败，请重试');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('发送失败，请重试');
            });
        }
        
        // 监听表单提交，成功后显示重发按钮
        document.querySelector('form').addEventListener('submit', function(e) {
            setTimeout(() => {
                if (!document.querySelector('.error')) {
                    startCountdown();
                }
            }, 100);
        });
    </script>
</body>
</html>