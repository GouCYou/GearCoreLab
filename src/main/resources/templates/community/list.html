<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°ç ç¤¾åŒº | CCTStudio - GearCoreLab</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <style>
        /* é…ç½®å•é€‰æ‹©æ ·å¼ - ç´§å‡‘ç‰ˆ */
        .config-selection {
            margin: 0.4rem 0 0.4rem 0;
            padding: 0.4rem;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .config-selection label {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }
        
        .config-selection label::before {
            content: "âš™ï¸";
            margin-right: 0.25rem;
            font-size: 14px;
        }
        
        .config-select {
            width: 100%;
            padding: 0.3rem 0.4rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .config-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .config-preview {
            margin-top: 0.4rem;
            padding: 0.4rem;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .config-preview h4 {
            margin: 0 0 0.25rem 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }
        
        .config-preview-content {
            font-size: 14px;
            color: #6c757d;
        }
        
        /* å¿«é€Ÿå‘å¸–è¡¨å•ä¼˜åŒ– - æ›´ç´§å‡‘è®¾è®¡ */
        .post-form-container {
            padding: 0.5rem;
            margin-bottom: 0.6rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        
        .post-form-container h2 {
            margin: 0 0 0.3rem 0.5rem;
            font-size: 1.5rem;
            color: #333;
            font-weight: 600;
        }
        
        .post-form input[type="text"],
        .post-form textarea {
            margin-bottom: 0.3rem;
            border-radius: 6px;
            padding: 0.4rem;
            font-size: 1rem;
        }
        
        .post-form textarea {
            min-height: 45px;
            max-height: 90px;
        }
        
        /* é…ç½®å•æ‚¬æµ®çª—æ ·å¼ */
        .config-tooltip {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            z-index: 1000;
            min-width: 250px;
            max-width: 320px;
            display: none;
            pointer-events: none;
            font-size: 0.9rem;
        }
        
        .config-tooltip-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .config-tooltip-title {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }
        
        .config-tooltip-components {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .config-tooltip-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .config-tooltip-item:last-child {
            border-bottom: none;
        }
        
        .config-tooltip-component {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .config-tooltip-component-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #667eea;
            font-size: 0.9rem;
        }
        
        .config-tooltip-component-name {
            font-size: 0.85rem;
            color: #333;
            font-weight: 500;
        }
        
        .config-tooltip-component-model {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.1rem;
        }
        
        .config-tooltip-price {
            font-size: 0.85rem;
            color: #28a745;
            font-weight: 600;
        }
        
        .config-tooltip-footer {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .config-tooltip-total {
            font-weight: 700;
            color: #333;
            font-size: 1rem;
        }
        
        .config-tooltip-power {
            font-size: 0.85rem;
            color: #666;
            resize: vertical;
        }
        
        /* é…ç½®å•ä¿¡æ¯æ¡æ ·å¼ - èƒ¶å›Šå‹è®¾è®¡ */
        .config-info-bar {
            margin: 1rem 0;
            padding: 0.6rem 1.2rem;
            background: #667eea;
            border: none;
            border-radius: 25px; /* èƒ¶å›Šå‹åœ†è§’ */
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.3);
            display: inline-block;
            max-width: fit-content;
        }
        
        .config-info-bar:hover {
            background: #5a67d8;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }
        
        .config-info-content {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            color: white;
        }
        
        .config-icon {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }
        
        .config-details {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        
        .config-name {
            font-weight: 600;
            color: white;
            font-size: 1rem;
        }
        
        .config-type {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
        }
        
        .config-price {
            font-weight: 600;
            color: white;
            font-size: 1rem;
        }
        
        .form-actions {
            margin-top: 0.2rem;
            display: flex;
            gap: 0.3rem;
        }
        
        /* æ‚¬æµ®æ–°å»ºå¸–å­æŒ‰é’® */
        .floating-new-post-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #74b9ff;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(116, 185, 255, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            text-decoration: none;
        }
        
        .floating-new-post-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(116, 185, 255, 0.6);
            background: #0984e3;
        }
        
        .floating-new-post-btn i {
            font-size: 16px;
        }
        
        @media (max-width: 768px) {
            .floating-new-post-btn {
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
            }
            
            .floating-new-post-btn span {
                display: none;
            }
        }

        /* åˆ†é¡µæ ·å¼ */
        .pagination-container {
            margin-top: 30px;
            padding: 20px 0;
            border-top: 1px solid #e2e8f0;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .pagination-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            color: #4a5568;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
            color: #2d3748;
            transform: translateY(-1px);
        }

        .pagination-numbers {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pagination-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            color: #4a5568;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .pagination-number:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
            color: #2d3748;
        }

        .pagination-number.active {
            background: #667eea;
            border-color: #667eea;
            color: #ffffff;
            font-weight: 600;
        }

        .pagination-number.active:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .pagination-ellipsis {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            color: #a0aec0;
            font-size: 14px;
        }

        .pagination-info {
            text-align: center;
            color: #718096;
            font-size: 13px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .pagination {
                flex-wrap: wrap;
                gap: 6px;
            }

            .pagination-btn {
                padding: 6px 12px;
                font-size: 13px;
            }

            .pagination-number {
                width: 32px;
                height: 32px;
                font-size: 13px;
            }

            .pagination-info {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div th:replace="fragments/header :: siteHeader('community')"></div>

    <div class="main-content-wrapper">
        <!-- å¿«æ·å‘å¸–è¡¨å•ï¼ˆä»…ç™»å½•ç”¨æˆ·å¯è§ï¼‰ -->
        <div class="content-container" th:if="${#authentication != null}">
            <div class="post-form-container">
                <h2>å¿«é€Ÿå‘å¸–</h2>
                <form class="post-form" th:action="@{/community/create}" method="post" enctype="multipart/form-data">
                    <input type="text" name="title" placeholder="è¾“å…¥æ ‡é¢˜" required>
                    <textarea name="content" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." required></textarea>
                    
                    <!-- é…ç½®å•é€‰æ‹© -->
                    <div class="config-selection">
                        <label for="configSelect">å¼•ç”¨é…ç½®å•ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                        <select id="configSelect" name="configId" class="config-select">
                            <option value="">ä¸å¼•ç”¨é…ç½®å•</option>
                            <!-- é…ç½®å•é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </select>
                    </div>
                    
                    <div class="image-preview" id="quickImagePreview"></div>

                    <div class="form-actions">
                        <input type="file" id="quickPostImages" name="images" accept="image/*" multiple style="display:none" onchange="previewQuickImages(this)">
                        <button type="button" class="image-upload-btn" onclick="document.getElementById('quickPostImages').click()">
                            ä¸Šä¼ å›¾ç‰‡
                        </button>
                        <button type="submit" class="submit-btn">å‘å¸ƒ</button>
                    </div>
                </form>
            </div>
        </div>

            <!-- å¸–å­åˆ—è¡¨å®¹å™¨ -->
            <div class="post-list-container">
                <!-- ç©ºåˆ—è¡¨æç¤º -->
                <div th:if="${#lists.isEmpty(posts)}" class="empty-post-list">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“</div>
                        <h3>è¿˜æ²¡æœ‰å¸–å­</h3>
                        <p>æˆä¸ºç¬¬ä¸€ä¸ªå‘å¸–çš„äººå§ï¼åˆ†äº«ä½ çš„æƒ³æ³•ã€é—®é¢˜æˆ–åˆ›æ„ã€‚</p>
                        <button class="primary-btn" th:if="${#authentication != null}" onclick="document.querySelector('.post-form textarea').focus()">ç«‹å³å‘å¸–</button>
                        <button class="primary-btn" th:unless="${#authentication != null}" onclick="redirectToLogin()">ç™»å½•å‘å¸–</button>
                    </div>
                </div>
                
                <div th:each="post : ${posts}" class="post-card" th:onclick="'showPostDetail(' + ${post.id} + ')'">
                    <div class="post-header">
                        <div class="author">
                            <img th:src="${post.authorAvatarUrl != null && !post.authorAvatarUrl.isEmpty() ? post.authorAvatarUrl : '/img/default-avatar.svg'}" alt="å¤´åƒ" class="avatar">
                            <a class="username" th:href="@{'/user/profile/' + ${post.authorUsername}}" th:text="${post.authorUsername}" onclick="event.stopPropagation()">
                            </a>
                        </div>
                        <div class="post-header-actions" th:if="${#authentication != null && (#authentication.name == post.authorUsername || #authorization.expression('hasRole(''ADMIN'')'))}">
                            <button class="delete-btn-small" th:onclick="'event.stopPropagation(); showDeleteConfirm(' + ${post.id} + ')'">
                                åˆ é™¤
                            </button>
                        </div>
                    </div>
                    <h3 class="title" th:text="${post.title}"></h3>
                    <p class="content" th:text="${post.content}"></p>
                    <div class="post-images" th:if="${not #lists.isEmpty(post.imageUrls)}">
                        <img th:each="imgUrl : ${post.imageUrls}"
                             th:src="@{${imgUrl}}"
                             alt="å›¾ç‰‡"
                             class="post-image post-preview-img">
                    </div>
                    <div class="post-actions">
                        <button class="like-btn post-like" th:classappend="${post.liked} ? 'liked' : ''" th:onclick="'togglePostLike(' + ${post.id} + ')'">
                            <span th:text="${post.likeCount}">0</span>
                            <i class="like-icon">â¤</i>
                        </button>
                        <button class="comment-btn" th:onclick="'showPostDetail(' + ${post.id} + ')'">
                            <span>è¯„è®º</span>
                            <span th:text="${post.commentCount != null ? post.commentCount : 0}">0</span>
                        </button>
                    </div>
                    <div class="post-meta">
                        <span class="date" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
                    </div>
                </div>
            </div>
            
            <!-- åˆ†é¡µæ§ä»¶ -->
            <div class="pagination-container" th:if="${totalPages > 1}">
                <div class="pagination">
                    <!-- ä¸Šä¸€é¡µ -->
                    <a th:if="${currentPage > 1}" 
                       th:href="@{/community(page=${currentPage - 1})}" 
                       class="pagination-btn prev-btn">
                        <i class="fas fa-chevron-left"></i>
                        ä¸Šä¸€é¡µ
                    </a>
                    
                    <!-- é¡µç  -->
                    <div class="pagination-numbers">
                        <!-- ç¬¬ä¸€é¡µ -->
                        <a th:if="${currentPage > 3}" 
                           th:href="@{/community(page=1)}" 
                           class="pagination-number">1</a>
                        
                        <!-- çœç•¥å· -->
                        <span th:if="${currentPage > 4}" class="pagination-ellipsis">...</span>
                        
                        <!-- å½“å‰é¡µå‰åçš„é¡µç  -->
                        <th:block th:each="page : ${#numbers.sequence(T(java.lang.Math).max(1, currentPage - 2), T(java.lang.Math).min(totalPages, currentPage + 2))}">
                            <a th:href="@{/community(page=${page})}" 
                               th:class="${page == currentPage} ? 'pagination-number active' : 'pagination-number'"
                               th:text="${page}"></a>
                        </th:block>
                        
                        <!-- çœç•¥å· -->
                        <span th:if="${currentPage < totalPages - 3}" class="pagination-ellipsis">...</span>
                        
                        <!-- æœ€åä¸€é¡µ -->
                        <a th:if="${currentPage < totalPages - 2}" 
                           th:href="@{/community(page=${totalPages})}" 
                           class="pagination-number" 
                           th:text="${totalPages}"></a>
                    </div>
                    
                    <!-- ä¸‹ä¸€é¡µ -->
                    <a th:if="${currentPage < totalPages}" 
                       th:href="@{/community(page=${currentPage + 1})}" 
                       class="pagination-btn next-btn">
                        ä¸‹ä¸€é¡µ
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </div>
                
                <!-- åˆ†é¡µä¿¡æ¯ -->
                <div class="pagination-info">
                    <span>ç¬¬ [[${currentPage}]] é¡µï¼Œå…± [[${totalPages}]] é¡µ | æ€»è®¡ [[${totalPosts}]] ä¸ªå¸–å­</span>
                </div>
            </div>
        </div>

        <!-- å¸–å­è¯¦æƒ…ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-content" id="sidebarContent">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

    <!-- è‡ªå®šä¹‰åˆ é™¤ç¡®è®¤å¼¹çª— -->
    <div class="delete-confirm-overlay" id="deleteConfirmOverlay" style="display:none;">
        <div class="delete-confirm-modal">
            <h3>ç¡®è®¤åˆ é™¤</h3>
            <p>ç¡®å®šè¦åˆ é™¤è¿™ç¯‡å¸–å­å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="hideDeleteConfirm()">å–æ¶ˆ</button>
                <button class="confirm-btn" onclick="confirmDelete()">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- è¯„è®ºåˆ é™¤ç¡®è®¤å¼¹çª— -->
    <div class="delete-confirm-overlay" id="commentDeleteConfirmOverlay" style="display:none;">
        <div class="delete-confirm-modal">
            <h3>ç¡®è®¤åˆ é™¤</h3>
            <p>ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="hideCommentDeleteConfirm()">å–æ¶ˆ</button>
                <button class="confirm-btn" onclick="confirmCommentDelete()">åˆ é™¤</button>
            </div>
        </div>
    </div>
    </div>

    <!-- æ·»åŠ ç™»å½•çŠ¶æ€æ ‡è®° -->
    <meta name="isAuthenticated" th:if="${#authentication != null && #authentication.name != 'anonymousUser'}" />

    <!-- é…ç½®å•æ‚¬æµ®çª— -->
    <div class="config-tooltip" id="configTooltip"></div>
    
    <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()" style="display:none;">
        <div class="image-modal-content">
            <span class="image-modal-close" onclick="closeImageModal(event)">&times;</span>
            <img id="modalImage" src="" alt="é¢„è§ˆå›¾ç‰‡">
        </div>
    </div>

    <script>
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
        function checkLogin() {
            return document.querySelector('meta[name="isAuthenticated"]') !== null;
        }

        // è·³è½¬åˆ°ç™»å½•é¡µé¢
        function redirectToLogin() {
            window.location.href = '/login';
        }
        
        // åŠ è½½ç”¨æˆ·é…ç½®å•åˆ—è¡¨
        function loadUserConfigs() {
            const configSelect = document.getElementById('configSelect');
            fetch('/api/user-configs')
                .then(res => {
                    if (!res.ok) {
                        throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + res.status);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('é…ç½®å•æ•°æ®:', data); // è°ƒè¯•ä¿¡æ¯
                    configSelect.innerHTML = '<option value="">ä¸å¼•ç”¨é…ç½®å•</option>';
                    if (data.success && Array.isArray(data.data)) {
                        window.userConfigs = data.data;
                        data.data.forEach(config => {
                            const option = document.createElement('option');
                            option.value = config.id;
                            option.textContent = config.title;
                            configSelect.appendChild(option);
                        });
                        console.log('æˆåŠŸåŠ è½½', data.data.length, 'ä¸ªé…ç½®å•'); // è°ƒè¯•ä¿¡æ¯
                    } else {
                        window.userConfigs = [];
                        console.log('é…ç½®å•æ•°æ®æ ¼å¼é”™è¯¯æˆ–ä¸ºç©º:', data); // è°ƒè¯•ä¿¡æ¯
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½é…ç½®å•å¤±è´¥:', error);
                    window.userConfigs = [];
                });
        }
        
        // é…ç½®å•é€‰æ‹©å˜åŒ–äº‹ä»¶ï¼ˆå·²ç§»é™¤é¢„è§ˆåŠŸèƒ½ï¼‰
        function onConfigSelectChange() {
            // é…ç½®å•é€‰æ‹©å˜åŒ–æ—¶ä¸å†æ˜¾ç¤ºé¢„è§ˆï¼Œä½†ä¿ç•™é€‰æ‹©åŠŸèƒ½
            // é€‰æ‹©çš„é…ç½®å•IDä¼šé€šè¿‡è¡¨å•æäº¤åˆ°åç«¯
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            if (checkLogin()) {
                loadUserConfigs();
                document.getElementById('configSelect').addEventListener('change', onConfigSelectChange);
            }
        });

        // å¿«æ·å‘å¸–å›¾ç‰‡é¢„è§ˆ
        function previewQuickImages(input) {
            const preview = document.getElementById('quickImagePreview');
            preview.innerHTML = '';

            if (input.files) {
                Array.from(input.files).slice(0, 9).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const div = document.createElement('div');
                        div.className = 'preview-item';

                        const img = document.createElement('img');
                        img.src = e.target.result;

                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove';
                        removeBtn.innerHTML = 'Ã—';
                        removeBtn.onclick = function(e) {
                            e.stopPropagation();
                            div.remove();
                            // æ¸…é™¤å¯¹åº”çš„æ–‡ä»¶
                            const dt = new DataTransfer();
                            const { files } = input;
                            for (let i = 0; i < files.length; i++) {
                                if (files[i] !== file) dt.items.add(files[i]);
                            }
                            input.files = dt.files;
                        };

                        div.appendChild(img);
                        div.appendChild(removeBtn);
                        preview.appendChild(div);
                    }
                    reader.readAsDataURL(file);
                });
            }
        }

        // æ˜¾ç¤ºå¸–å­è¯¦æƒ…
        function showPostDetail(postId) {
            const sidebar = document.getElementById('sidebar');
            const sidebarContent = document.getElementById('sidebarContent');
            const mainWrapper = document.querySelector('.main-content-wrapper');
            
            // æ˜¾ç¤ºä¾§è¾¹æ 
            sidebar.classList.add('active');
            if (mainWrapper) {
                mainWrapper.classList.add('has-sidebar');
            }
            
            // åŠ è½½å¸–å­è¯¦æƒ…å†…å®¹
            sidebarContent.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            fetch(`/community/${postId}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                // æå–å¸–å­è¯¦æƒ…å†…å®¹
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const postDetail = doc.querySelector('.post-detail');
                if (postDetail) {
                    // åœ¨å¸–å­è¯¦æƒ…å‰æ·»åŠ å…³é—­æŒ‰é’®
                    const closeButton = '<div class="sidebar-close-section"><button class="close-btn" onclick="hidePostDetail()">å…³é—­</button></div>';
                    sidebarContent.innerHTML = closeButton + postDetail.outerHTML;
                    // é‡æ–°ç»‘å®šäº‹ä»¶ï¼ˆä¿®æ­£ï¼šç»‘å®šå›¾ç‰‡é¢„è§ˆï¼‰
                    bindDetailEventsWithPreview();
                    // è‡ªåŠ¨é«˜äº®ç‚¹èµæŒ‰é’®
                    const likeBtn = sidebarContent.querySelector('.post-detail .like-btn.post-like');
                    if (likeBtn) {
                        if (likeBtn.className.includes('liked')) {
                            likeBtn.classList.add('liked');
                        } else {
                            likeBtn.classList.remove('liked');
                        }
                    }
                }
            })
            .catch(error => {
                sidebarContent.innerHTML = '<div class="error">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            });
        }

        // éšè—å¸–å­è¯¦æƒ…
        function hidePostDetail() {
            const sidebar = document.getElementById('sidebar');
            const mainWrapper = document.querySelector('.main-content-wrapper');
            
            sidebar.classList.remove('active');
            if (mainWrapper) {
                mainWrapper.classList.remove('has-sidebar');
            }
        }
        
        // å…¼å®¹æ—§å‡½æ•°å
        function openPostDetail(postId) {
            showPostDetail(postId);
        }
        
        function closePostDetail() {
            hidePostDetail();
        }

        // ç»‘å®šè¯¦æƒ…é¡µé¢çš„äº‹ä»¶
        function bindDetailEvents() {
            // é‡æ–°ç»‘å®šç‚¹èµç­‰äº‹ä»¶
            const likeButtons = document.querySelectorAll('#sidebarContent .like-btn');
            likeButtons.forEach(btn => {
                btn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    // ä»æŒ‰é’®çš„data-post-idå±æ€§æˆ–URLä¸­è·å–postId
                    let postId = this.getAttribute('data-post-id');
                    // å¦‚æœæ²¡æœ‰data-post-idå±æ€§ï¼Œå°è¯•ä»onclickå±æ€§ä¸­æå–
                    if (!postId) {
                        const onclickAttr = this.getAttribute('onclick');
                        if (onclickAttr && onclickAttr.includes('togglePostLike')) {
                            const match = onclickAttr.match(/togglePostLike\((\d+)\)/);
                            if (match) {
                                postId = match[1];
                            }
                        }
                    }
                    // å¦‚æœä»ç„¶æ²¡æœ‰æ‰¾åˆ°postIdï¼Œå°è¯•ä»URLä¸­è·å–
                    if (!postId) {
                        const currentUrl = window.location.pathname;
                        const urlMatch = currentUrl.match(/\/community\/(\d+)/);
                        if (urlMatch) {
                            postId = urlMatch[1];
                        }
                    }
                    if (postId) {
                        togglePostLike(postId);
                    }
                };
            });
            // é‡æ–°ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            const deleteButtons = document.querySelectorAll('#sidebarContent .delete-btn, #sidebarContent .delete-btn-small');
            deleteButtons.forEach(btn => {
                btn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    // ä»æŒ‰é’®çš„data-post-idå±æ€§æˆ–onclickå±æ€§ä¸­æå–postId
                    let postId = this.getAttribute('data-post-id');
                    if (!postId) {
                        const onclickAttr = this.getAttribute('onclick');
                        if (onclickAttr) {
                            const match = onclickAttr.match(/(?:deletePost|showDeleteConfirm)\((\d+)\)/);
                            if (match) {
                                postId = match[1];
                            }
                        }
                    }
                    if (!postId) {
                        const currentUrl = window.location.pathname;
                        const urlMatch = currentUrl.match(/\/community\/(\d+)/);
                        if (urlMatch) {
                            postId = urlMatch[1];
                        }
                    }
                    if (postId) {
                        showDeleteConfirm(postId);
                    }
                };
            });
            // é‡æ–°ç»‘å®šå›¾ç‰‡ä¸Šä¼ å’Œè¯„è®ºè¡¨å•äº‹ä»¶
            const commentForm = document.querySelector('#sidebarContent #commentForm');
            if (commentForm) {
                commentForm.onsubmit = submitComment;
                const imageInput = commentForm.querySelector('#commentImages');
                if (imageInput) {
                    imageInput.onchange = function() {
                        previewImages(this);
                    };
                }
            }
            // ç»‘å®šè¯„è®ºåˆ é™¤æŒ‰é’®
            bindCommentEvents();
            // ç»‘å®šå¸–å­ç‚¹èµæŒ‰é’®äº‹ä»¶ï¼ˆå…ˆè§£ç»‘å†ç»‘å®šï¼Œé˜²æ­¢å¤šæ¬¡ç»‘å®šæˆ–è¢«è¦†ç›–ï¼‰
            const postLikeBtn = document.querySelector('#sidebarContent .post-detail .like-btn');
            if (postLikeBtn) {
                postLikeBtn.onclick = null;
                postLikeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    let postId = this.getAttribute('data-post-id');
                    if (!postId) {
                        const onclickAttr = this.getAttribute('onclick');
                        if (onclickAttr && onclickAttr.includes('togglePostLike')) {
                            const match = onclickAttr.match(/togglePostLike\((\d+)\)/);
                            if (match) {
                                postId = match[1];
                            }
                        }
                    }
                    if (postId) {
                        togglePostLike(postId);
                    }
                });
                
                // æ£€æŸ¥å¹¶è®¾ç½®ç‚¹èµæŒ‰é’®çš„åˆå§‹çŠ¶æ€
                const onclickAttr = postLikeBtn.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes('togglePostLike')) {
                    const match = onclickAttr.match(/togglePostLike\((\d+)\)/);
                    if (match) {
                        const postId = match[1];
                        // ä»ä¸»åˆ—è¡¨ä¸­è·å–å¯¹åº”å¸–å­çš„ç‚¹èµçŠ¶æ€
                        const mainPostCard = document.querySelector(`.post-card .like-btn[onclick*="${postId}"]`);
                        if (mainPostCard && mainPostCard.classList.contains('liked')) {
                            postLikeBtn.classList.add('liked');
                        }
                    }
                }
            }
            // ç»‘å®šè¯„è®ºç‚¹èµæŒ‰é’®äº‹ä»¶ï¼ˆå…ˆè§£ç»‘å†ç»‘å®šï¼Œé˜²æ­¢å¤šæ¬¡ç»‘å®šæˆ–è¢«è¦†ç›–ï¼‰
            const commentLikeButtons = document.querySelectorAll('#sidebarContent .comment .like-btn');
            commentLikeButtons.forEach(btn => {
                btn.onclick = null;
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    let commentId = null;
                    const onclickAttr = this.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes('toggleCommentLike')) {
                        const match = onclickAttr.match(/toggleCommentLike\((\d+),/);
                        if (match) {
                            commentId = match[1];
                        }
                    }
                    if (!commentId) {
                        commentId = this.getAttribute('data-comment-id');
                    }
                    if (commentId) {
                        toggleCommentLike(commentId, this);
                    }
                });
            });
        }

        // ========== è¯„è®ºç›¸å…³å‡½æ•°ï¼ˆä» detail.html å¤åˆ¶ï¼‰ ==========
        function previewImages(input) {
            const preview = document.getElementById('imagePreview');
            if (preview) preview.innerHTML = '';
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove';
                    removeBtn.innerHTML = 'Ã—';
                    removeBtn.onclick = function(e) {
                        e.stopPropagation();
                        div.remove();
                        input.value = '';
                    };
                    div.appendChild(img);
                    div.appendChild(removeBtn);
                    if (preview) preview.appendChild(div);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        function submitComment(event) {
            event.preventDefault();
            event.stopPropagation();
            if (!checkLogin()) {
                redirectToLogin();
                return;
            }
            const postIdInput = document.querySelector('#sidebarContent #commentPostId');
            const contentInput = document.querySelector('#sidebarContent #commentContent');
            const imageInput = document.querySelector('#sidebarContent #commentImages');
            if (!contentInput || !postIdInput) return;
            const postId = postIdInput.value;
            const content = contentInput.value;
            if (!content.trim()) {
                showCustomAlert('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º', 'warning');
                return;
            }
            const formData = new FormData();
            formData.append('postId', postId);
            formData.append('content', content);
            if (imageInput && imageInput.files.length > 0) {
                formData.append('image', imageInput.files[0]);
            }
            const submitBtn = document.querySelector('#sidebarContent .submit-btn');
            const originalText = submitBtn ? submitBtn.textContent : '';
            if (submitBtn) {
                submitBtn.textContent = 'æäº¤ä¸­...';
                submitBtn.disabled = true;
            }
            fetch('/comment/add', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(html => {
                if (contentInput) contentInput.value = '';
                const preview = document.getElementById('imagePreview');
                if (preview) preview.innerHTML = '';
                if (imageInput) imageInput.value = '';
                refreshComments(postId);
                if (submitBtn) {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('æäº¤è¯„è®ºå¤±è´¥:', error);
                if (submitBtn) {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
                showCustomAlert('æäº¤è¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            });
        }
        function refreshComments(postId) {
            fetch(`/community/${postId}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const commentsSection = doc.querySelector('.comments');
                if (commentsSection) {
                    const currentComments = document.querySelector('#sidebarContent .comments');
                    const commentForm = currentComments ? currentComments.querySelector('.post-form-container') : null;
                    const newComments = document.createElement('div');
                    newComments.className = 'comments';
                    newComments.id = 'comments';
                    const title = document.createElement('h3');
                    title.textContent = 'è¯„è®ºåŒº';
                    newComments.appendChild(title);
                    if (commentForm) {
                        newComments.appendChild(commentForm.cloneNode(true));
                    }
                    const commentItems = commentsSection.querySelectorAll('.comment');
                        commentItems.forEach(item => {
                            // æ›´æ–°è¯„è®ºç»“æ„ä»¥åŒ¹é…æ–°çš„å¸ƒå±€
                            const clonedItem = item.cloneNode(true);
                            newComments.appendChild(clonedItem);
                        });
                    if (currentComments) currentComments.replaceWith(newComments);
                    bindCommentEvents();
                }
            })
            .catch(error => {
                console.error('åˆ·æ–°è¯„è®ºå¤±è´¥:', error);
            });
        }
        function bindCommentEvents() {
            const deleteButtons = document.querySelectorAll('#sidebarContent .comment-delete-btn');
            deleteButtons.forEach(btn => {
                btn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const commentId = this.getAttribute('data-comment-id');
                    showCommentDeleteConfirm(commentId);
                };
            });
        }
        function deleteComment(commentId) {
            fetch(`/comment/delete/${commentId}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    const postIdInput = document.querySelector('#sidebarContent #commentPostId');
                    const postId = postIdInput ? postIdInput.value : null;
                    if (postId) refreshComments(postId);
                } else {
                    showCustomAlert('åˆ é™¤è¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            })
            .catch(error => {
                console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
                showCustomAlert('åˆ é™¤è¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            });
        }

        // å¸–å­ç‚¹èµ
        function togglePostLike(postId) {
            if (!checkLogin()) {
                redirectToLogin();
                return;
            }

            // æ·»åŠ ç‚¹å‡»åŠ¨æ•ˆ
            const clickedBtn = event.target.closest('.like-btn');
            if (clickedBtn) {
                clickedBtn.style.animation = 'likeAnimation 0.3s ease';
                setTimeout(() => {
                    clickedBtn.style.animation = '';
                }, 300);
            }

            fetch(`/community/${postId}/like`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.status === 401) {
                    redirectToLogin();
                    return;
                }
                return response.text();
            })
            .then(data => {
                // è§£æå“åº”æ•°æ®
                const isLiked = data === 'liked';
                const isUnliked = data === 'unliked';
                
                if (isLiked || isUnliked) {
                    // è·å–å½“å‰ç‚¹èµæ•°
                    fetch(`/community/${postId}`, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const likeCountElement = doc.querySelector('#postLikeCount');
                        const likeCount = likeCountElement ? likeCountElement.textContent : '0';
                        
                        // æ›´æ–°ä¸»åˆ—è¡¨ä¸­çš„ç‚¹èµæŒ‰é’®
                        const mainLikeBtn = document.querySelector(`.post-card .like-btn[onclick*="${postId}"]`);
                        if (mainLikeBtn) {
                            const mainCountSpan = mainLikeBtn.querySelector('span');
                            if (mainCountSpan) {
                                mainCountSpan.textContent = likeCount;
                            }
                            if (isLiked) {
                                mainLikeBtn.classList.add('liked');
                                // æ·»åŠ ç‚¹èµæˆåŠŸåŠ¨æ•ˆ
                                mainLikeBtn.style.animation = 'likeAnimation 0.3s ease';
                                setTimeout(() => {
                                    mainLikeBtn.style.animation = '';
                                }, 300);
                            } else {
                                mainLikeBtn.classList.remove('liked');
                            }
                        }
                        
                        // æ›´æ–°ä¾§è¾¹æ ä¸­çš„ç‚¹èµæŒ‰é’®
                        const sidebarLikeBtn = document.querySelector('#sidebarContent .like-btn');
                        if (sidebarLikeBtn) {
                            const sidebarCountSpan = sidebarLikeBtn.querySelector('span');
                            if (sidebarCountSpan) {
                                sidebarCountSpan.textContent = likeCount;
                            }
                            if (isLiked) {
                                sidebarLikeBtn.classList.add('liked');
                                // æ·»åŠ ç‚¹èµæˆåŠŸåŠ¨æ•ˆ
                                sidebarLikeBtn.style.animation = 'likeAnimation 0.3s ease';
                                setTimeout(() => {
                                    sidebarLikeBtn.style.animation = '';
                                }, 300);
                            } else {
                                sidebarLikeBtn.classList.remove('liked');
                            }
                        }
                    });
                }
            })
            .catch(error => {
                console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
            });
        }
        
        // å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
        function previewImage(src, alt = '') {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.9);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s ease;
                backdrop-filter: blur(4px);
            `;
            const container = document.createElement('div');
            container.style.cssText = `
                position: relative;
                max-width: 90vw;
                max-height: 90vh;
                transform: scale(0.8);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            `;
            const img = document.createElement('img');
            img.src = src;
            img.alt = alt;
            img.style.cssText = `
                width: auto;
                height: auto;
                max-width: 80vw;
                max-height: 80vh;
                object-fit: contain;
                border-radius: 8px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                transition: transform 0.3s ease;
            `;
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = 'Ã—';
            closeBtn.style.cssText = `
                position: fixed;
                top: 30px;
                right: 30px;
                width: 50px;
                height: 50px;
                border: none;
                border-radius: 50%;
                background: rgba(0, 0, 0, 0.7);
                color: white;
                font-size: 24px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 10001;
                font-weight: bold;
            `;
            closeBtn.addEventListener('mouseenter', () => {
                closeBtn.style.background = 'rgba(255, 255, 255, 0.9)';
                closeBtn.style.color = '#333';
                closeBtn.style.transform = 'scale(1.1)';
            });
            closeBtn.addEventListener('mouseleave', () => {
                closeBtn.style.background = 'rgba(0, 0, 0, 0.7)';
                closeBtn.style.color = 'white';
                closeBtn.style.transform = 'scale(1)';
            });
            let scale = 1;
            // é¼ æ ‡æ»šè½®ç¼©æ”¾
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                scale = Math.max(0.5, Math.min(3, scale + delta));
                img.style.transform = `scale(${scale})`;
            });
            // å…³é—­é¢„è§ˆ
            const closePreview = () => {
                overlay.style.opacity = '0';
                container.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                }, 300);
            };
            closeBtn.addEventListener('click', closePreview);
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closePreview();
            });
            // ESCé”®å…³é—­
            const handleKeydown = (e) => {
                if (e.key === 'Escape') {
                    closePreview();
                    document.removeEventListener('keydown', handleKeydown);
                }
            };
            document.addEventListener('keydown', handleKeydown);
            container.appendChild(img);
            overlay.appendChild(container);
            overlay.appendChild(closeBtn);
            document.body.appendChild(overlay);
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                overlay.style.opacity = '1';
                container.style.transform = 'scale(1)';
            }, 10);
        }
        function closeImageModal(event) {
            if (event) event.stopPropagation();
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'none';
            modalImg.src = '';
            document.body.style.overflow = 'auto';
        }
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        });
        
        // æœç´¢åŠŸèƒ½
        function handleSearch(event) {
            if (event) {
                event.preventDefault();
            }
            
            const searchInput = document.querySelector('.search-input');
            const query = searchInput ? searchInput.value.trim() : '';
            
            if (query) {
                window.location.href = `/search?q=${encodeURIComponent(query)}`;
            }
        }
        
        // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            const searchBtn = document.querySelector('.search-btn');
            if (searchBtn) {
                searchBtn.addEventListener('click', handleSearch);
            }
            
            // æœç´¢è¾“å…¥æ¡†å›è½¦äº‹ä»¶
            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        handleSearch(event);
                    }
                });
            }
            
            // æœç´¢æ¡†å±•å¼€æ—¶è‡ªåŠ¨èšç„¦
            const searchBox = document.querySelector('.search-box');
            if (searchBox) {
                searchBox.addEventListener('mouseenter', function() {
                    setTimeout(() => {
                        const input = this.querySelector('.search-input');
                        if (input) {
                            input.focus();
                        }
                    }, 300);
                });
            }
            
            // ESCé”®å…³é—­å¸–å­è¯¦æƒ…
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar && sidebar.classList.contains('active')) {
                        hidePostDetail();
                    }
                }
            });
        });

        window.toggleCommentLike = function(commentId, el) {
            if (!checkLogin()) {
                redirectToLogin();
                return;
            }
            
            // æ·»åŠ ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
            el.style.transform = 'scale(0.95)';
            setTimeout(() => {
                el.style.transform = '';
            }, 150);
            
            fetch(`/comment/like/${commentId}`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.status === 401) {
                    redirectToLogin();
                    return null;
                }
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(res => {
                if (!res) return;
                
                if (res === 'login') {
                    redirectToLogin();
                    return;
                }
                
                const span = el.querySelector('span');
                let c = parseInt(span.innerText) || 0;
                
                if (res === 'liked') {
                    el.classList.add('liked');
                    span.innerText = c + 1;
                    // æ·»åŠ ç‚¹èµæˆåŠŸçš„è§†è§‰åé¦ˆ
                    el.style.animation = 'likeAnimation 0.3s ease';
                } else if (res === 'unliked') {
                    el.classList.remove('liked');
                    span.innerText = Math.max(0, c - 1);
                }
                
                // æ¸…é™¤åŠ¨ç”»
                setTimeout(() => {
                    el.style.animation = '';
                }, 300);
            })
            .catch(error => {
                console.error('Error:', error);
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                el.style.transform = '';
            });
        }

        window.showDeleteConfirm = function(postId) {
            // è®°å½•è¦åˆ é™¤çš„å¸–å­ID
            window.deletePostId = postId;
            const overlay = document.getElementById('deleteConfirmOverlay');
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
        }
        window.hideDeleteConfirm = function() {
            window.deletePostId = null;
            document.getElementById('deleteConfirmOverlay').style.display = 'none';
        }
        window.confirmDelete = function() {
            if (window.deletePostId) {
                window.location.href = '/community/' + window.deletePostId + '/delete';
            }
            window.hideDeleteConfirm();
        }

        let deleteCommentId = null;
        function showCommentDeleteConfirm(commentId) {
            deleteCommentId = commentId;
            const overlay = document.getElementById('commentDeleteConfirmOverlay');
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
        }
        function hideCommentDeleteConfirm() {
            deleteCommentId = null;
            document.getElementById('commentDeleteConfirmOverlay').style.display = 'none';
        }
        function confirmCommentDelete() {
            if (deleteCommentId) {
                deleteComment(deleteCommentId);
            }
            hideCommentDeleteConfirm();
        }
        
        // è‡ªå®šä¹‰å¼¹çª—å‡½æ•°
        function showCustomAlert(message, type = 'info', title = '', showCancel = false) {
            return new Promise((resolve) => {
                // åˆ›å»ºé®ç½©å±‚
                const overlay = document.createElement('div');
                overlay.className = 'custom-alert-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                
                // åˆ›å»ºå¼¹çª—
                const alert = document.createElement('div');
                alert.className = 'custom-alert';
                alert.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 0;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                    transform: scale(0.8);
                    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    overflow: hidden;
                `;
                
                // è®¾ç½®å›¾æ ‡
                const icons = {
                    success: 'fas fa-check',
                    error: 'fas fa-times',
                    warning: 'fas fa-exclamation-triangle',
                    info: 'fas fa-info'
                };
                
                const iconColors = {
                    success: '#4CAF50',
                    error: '#f44336',
                    warning: '#ff9800',
                    info: '#2196F3'
                };
                
                // è®¾ç½®æ ‡é¢˜
                const titles = {
                    success: title || 'æˆåŠŸ',
                    error: title || 'é”™è¯¯',
                    warning: title || 'è­¦å‘Š',
                    info: title || 'æç¤º'
                };
                
                alert.innerHTML = `
                    <div style="padding: 24px; display: flex; align-items: flex-start; gap: 16px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: ${iconColors[type]}; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="${icons[type]}" style="color: white; font-size: 18px;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 18px; font-weight: 600; color: #333; margin-bottom: 8px;">${titles[type]}</div>
                            <div style="color: #666; line-height: 1.5;">${message}</div>
                        </div>
                    </div>
                    <div style="padding: 16px 24px; background: #f8f9fa; display: flex; gap: 12px; justify-content: flex-end;">
                        ${showCancel ? '<button class="custom-alert-btn secondary" style="padding: 8px 16px; border: 1px solid #ddd; background: white; color: #666; border-radius: 6px; cursor: pointer; font-size: 14px;" onclick="closeCustomAlert(false)">å–æ¶ˆ</button>' : ''}
                        <button class="custom-alert-btn primary" style="padding: 8px 16px; border: none; background: #007bff; color: white; border-radius: 6px; cursor: pointer; font-size: 14px;" onclick="closeCustomAlert(true)">ç¡®å®š</button>
                    </div>
                `;
                
                // æ·»åŠ åˆ°é¡µé¢
                overlay.appendChild(alert);
                document.body.appendChild(overlay);
                
                // æ˜¾ç¤ºåŠ¨ç”»
                setTimeout(() => {
                    overlay.style.opacity = '1';
                    alert.style.transform = 'scale(1)';
                }, 10);
                
                // å…³é—­å‡½æ•°
                window.closeCustomAlert = function(result) {
                    overlay.style.opacity = '0';
                    alert.style.transform = 'scale(0.8)';
                    
                    setTimeout(() => {
                        document.body.removeChild(overlay);
                        delete window.closeCustomAlert;
                        resolve(result);
                    }, 300);
                };
                
                // ç‚¹å‡»é®ç½©å±‚å…³é—­
                overlay.addEventListener('click', () => window.closeCustomAlert(false));
            });
        }
        
        // å¸–å­åˆ—è¡¨å›¾ç‰‡é¢„è§ˆäº‹ä»¶ç»‘å®š
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.post-preview-img').forEach(function(img) {
                img.style.cursor = 'zoom-in';
                img.onclick = function(e) {
                    e.stopPropagation();
                    previewImage(this.src, this.alt);
                };
            });
        });
        // å³ä¾§è¯¦æƒ…å¼¹å‡ºåä¹Ÿè¦ç»‘å®š
        function bindDetailEventsWithPreview() {
            bindDetailEvents && bindDetailEvents();
            document.querySelectorAll('#sidebarContent img').forEach(function(img) {
                img.style.cursor = 'zoom-in';
                img.onclick = function(e) {
                    e.stopPropagation();
                    previewImage(this.src, this.alt);
                };
            });
        }
        // æ›¿æ¢åŸæœ‰bindDetailEventsè°ƒç”¨
        const oldShowPostDetail = showPostDetail;
        showPostDetail = function(postId) {
            oldShowPostDetail(postId);
            setTimeout(bindDetailEventsWithPreview, 350);
        };
        
        // ========== é…ç½®ç›¸å…³å‡½æ•° ==========
        
        // é…ç½®ç¼“å­˜
        window.configCache = {};
        
        // åŠ è½½é…ç½®è¯¦æƒ…
        function loadConfigDetails(configId) {
            if (!configId) return;
            
            // å¦‚æœå·²ç»ç¼“å­˜ï¼Œç›´æ¥è¿”å›
            if (window.configCache[configId]) {
                return;
            }
            
            fetch(`/api/user-configs/${configId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    const config = data.data;
                    const configData = JSON.parse(config.configData || '{}');
                    
                    // ç¼“å­˜é…ç½®æ•°æ®
                    window.configCache[configId] = {
                        id: config.id,
                        title: config.title,
                        components: configData.components || {},
                        specs: configData.specs || {}
                    };
                    
                    // æ›´æ–°é¡µé¢æ˜¾ç¤º
                    updateConfigDisplay(configId, window.configCache[configId]);
                }
            })
            .catch(error => {
                console.error('Error loading config details:', error);
            });
        }
        
        // æ›´æ–°é…ç½®æ˜¾ç¤º
        function updateConfigDisplay(configId, config) {
            const configBars = document.querySelectorAll(`[data-config-id="${configId}"]`);
            configBars.forEach(bar => {
                const titleElement = bar.querySelector('.config-name');
                const typeElement = bar.querySelector('.config-type');
                const priceElement = bar.querySelector('.config-price');
                
                if (titleElement) titleElement.textContent = config.title || 'æœªå‘½åé…ç½®';
                if (typeElement) typeElement.textContent = getConfigType(config.components);
                if (priceElement) priceElement.textContent = 'Â¥' + calculateTotalPrice(config.components).toLocaleString();
            });
        }
        
        // è·å–é…ç½®ç±»å‹
        function getConfigType(components) {
            const cpu = components.cpu;
            const gpu = components.gpu;
            
            let type = '';
            if (cpu && cpu.name) {
                if (cpu.name.toLowerCase().includes('intel')) {
                    type += 'Intel';
                } else if (cpu.name.toLowerCase().includes('amd')) {
                    type += 'AMD';
                }
            }
            
            if (gpu && gpu.name) {
                if (type) type += ' + ';
                if (gpu.name.toLowerCase().includes('nvidia') || gpu.name.toLowerCase().includes('rtx') || gpu.name.toLowerCase().includes('gtx')) {
                    type += 'NVIDIA';
                } else if (gpu.name.toLowerCase().includes('amd') || gpu.name.toLowerCase().includes('radeon')) {
                    type += 'AMD';
                }
            }
            
            return type || 'é€šç”¨é…ç½®';
        }
        
        // ä»specsä¸­è§£æåŠŸè€—ä¿¡æ¯
        function getPowerFromSpecs(specs) {
            if (!specs) return 0;
            
            try {
                const specsObj = typeof specs === 'string' ? JSON.parse(specs) : specs;
                
                // æŸ¥æ‰¾åŠŸè€—ç›¸å…³å­—æ®µ
                for (const [key, value] of Object.entries(specsObj)) {
                    const keyLower = key.toLowerCase();
                    if (keyLower.includes('power') || keyLower.includes('åŠŸè€—') || keyLower.includes('tdp')) {
                        const powerMatch = String(value).match(/(\d+)\s*w/i);
                        if (powerMatch) {
                            return parseInt(powerMatch[1]);
                        }
                    }
                }
            } catch (e) {
                console.warn('è§£æspecså¤±è´¥:', e);
            }
            
            return 0;
        }
        
        // è®¡ç®—æ€»ä»·æ ¼
        function calculateTotalPrice(components) {
            let total = 0;
            
            if (components.cpu && components.cpu.price) total += Number(components.cpu.price);
            if (components.motherboard && components.motherboard.price) total += Number(components.motherboard.price);
            if (components.ram && components.ram.price) total += Number(components.ram.price);
            if (components.gpu && components.gpu.price) total += Number(components.gpu.price);
            if (components.psu && components.psu.price) total += Number(components.psu.price);
            if (components.case && components.case.price) total += Number(components.case.price);
            
            if (components.storage && Array.isArray(components.storage)) {
                components.storage.forEach(storage => {
                    if (storage.price) total += Number(storage.price);
                });
            }
            
            return total;
        }
        
        // è®¡ç®—æ€»åŠŸè€—
        function calculateTotalPower(components) {
            let total = 0;
            
            if (components.cpu) {
                total += components.cpu.power || getPowerFromSpecs(components.cpu.specs);
            }
            if (components.motherboard) {
                total += components.motherboard.power || getPowerFromSpecs(components.motherboard.specs);
            }
            if (components.ram) {
                total += components.ram.power || getPowerFromSpecs(components.ram.specs);
            }
            if (components.gpu) {
                total += components.gpu.power || getPowerFromSpecs(components.gpu.specs);
            }
            if (components.case) {
                total += components.case.power || getPowerFromSpecs(components.case.specs);
            }
            
            if (components.storage && Array.isArray(components.storage)) {
                components.storage.forEach(storage => {
                    total += storage.power || getPowerFromSpecs(storage.specs);
                });
            }
            
            return total;
        }
        
        // æ˜¾ç¤ºé…ç½®å•æ‚¬æµ®çª—
        function showConfigTooltip(element) {
            const configId = element.getAttribute('data-config-id');
            
            // ä»ç¼“å­˜ä¸­è·å–é…ç½®æ•°æ®
            const config = window.configCache && window.configCache[configId];
            
            if (!config) {
                // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œå°è¯•é‡æ–°åŠ è½½
                loadConfigDetails(configId);
                return;
            }
            
            const tooltip = document.getElementById('configTooltip');
            const components = config.components;
            
            // ç»„ä»¶å›¾æ ‡æ˜ å°„
            const componentIcons = {
                cpu: 'fas fa-microchip',
                motherboard: 'fas fa-memory',
                ram: 'fas fa-memory',
                gpu: 'fas fa-tv',
                psu: 'fas fa-bolt',
                case: 'fas fa-cube'
            };
            
            // ç»„ä»¶åç§°æ˜ å°„
            const componentNames = {
                cpu: 'CPU',
                motherboard: 'ä¸»æ¿',
                ram: 'å†…å­˜',
                gpu: 'æ˜¾å¡',
                psu: 'ç”µæº',
                case: 'æœºç®±'
            };
            
            let tooltipContent = `
                <div class="config-tooltip-header">
                    <i class="fas fa-cog" style="color: #667eea;"></i>
                    <span class="config-tooltip-title">${config.title || 'æœªå‘½åé…ç½®'}</span>
                </div>
                <div class="config-tooltip-components">
            `;
            
            // æ·»åŠ ä¸»è¦ç»„ä»¶
            Object.keys(componentNames).forEach(key => {
                const component = components[key];
                if (component && component.name) {
                    tooltipContent += `
                        <div class="config-tooltip-item">
                            <div class="config-tooltip-component">
                                <div class="config-tooltip-component-icon">
                                    <i class="${componentIcons[key]}"></i>
                                </div>
                                <div>
                                    <div class="config-tooltip-component-name">${componentNames[key]}</div>
                                    <div class="config-tooltip-component-model">${component.name || 'æœªé€‰æ‹©'}</div>
                                </div>
                            </div>
                            <div class="config-tooltip-price">Â¥${(component.price || 0).toLocaleString()}</div>
                        </div>
                    `;
                }
            });
            
            // æ·»åŠ å­˜å‚¨ç»„ä»¶
            if (components.storage && Array.isArray(components.storage)) {
                components.storage.forEach((storage, index) => {
                    if (storage && storage.name) {
                        tooltipContent += `
                            <div class="config-tooltip-item">
                                <div class="config-tooltip-component">
                                    <div class="config-tooltip-component-icon">
                                        <i class="fas fa-hdd"></i>
                                    </div>
                                    <div>
                                        <div class="config-tooltip-component-name">å­˜å‚¨ ${index + 1}</div>
                                        <div class="config-tooltip-component-model">${storage.name || 'æœªé€‰æ‹©'}</div>
                                    </div>
                                </div>
                                <div class="config-tooltip-price">Â¥${(storage.price || 0).toLocaleString()}</div>
                            </div>
                        `;
                    }
                });
            }
            
            // è®¡ç®—æ€»ä»·å’ŒåŠŸè€—
            const totalPrice = calculateTotalPrice(components);
            const totalPower = calculateTotalPower(components);
            
            tooltipContent += `
                </div>
                <div class="config-tooltip-footer">
                    <div class="config-tooltip-total">æ€»è®¡: Â¥${totalPrice.toLocaleString()}</div>
                    <div class="config-tooltip-power">åŠŸè€—: ${totalPower}W</div>
                </div>
            `;
            
            tooltip.innerHTML = tooltipContent;
            
            // å®šä½æ‚¬æµ®çª— - æ˜¾ç¤ºåœ¨ä¸‹æ–¹
            const rect = element.getBoundingClientRect();
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.bottom + 10) + 'px';
            tooltip.style.display = 'block';
            
            // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå±å¹•è¾¹ç•Œ
            setTimeout(() => {
                const tooltipRect = tooltip.getBoundingClientRect();
                if (tooltipRect.right > window.innerWidth) {
                    tooltip.style.left = (window.innerWidth - tooltipRect.width - 10) + 'px';
                }
                if (tooltipRect.bottom > window.innerHeight) {
                    tooltip.style.top = (rect.top - tooltipRect.height - 10) + 'px';
                }
            }, 10);
        }
        
        // éšè—é…ç½®å•æ‚¬æµ®çª—
        function hideConfigTooltip() {
            const tooltip = document.getElementById('configTooltip');
            tooltip.style.display = 'none';
        }
        
        // ä¸ºé…ç½®ä¿¡æ¯æ æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        function addConfigEvents() {
            document.querySelectorAll('[data-config-id]').forEach(element => {
                const configId = element.getAttribute('data-config-id');
                if (configId) {
                    // åŠ è½½é…ç½®è¯¦æƒ…
                    loadConfigDetails(configId);
                    
                    // æ·»åŠ é¼ æ ‡äº‹ä»¶
                    element.addEventListener('mouseenter', function() {
                        showConfigTooltip(this);
                    });
                    
                    element.addEventListener('mouseleave', function() {
                        hideConfigTooltip();
                    });
                }
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåï¼Œä¸ºæ‰€æœ‰é…ç½®ä¿¡æ¯æ åŠ è½½æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            addConfigEvents();
        });
        
        // ä¿®æ”¹showPostDetailå‡½æ•°ï¼Œåœ¨ä¾§è¾¹æ åŠ è½½åé‡æ–°ç»‘å®šé…ç½®äº‹ä»¶
        const originalShowPostDetail = showPostDetail;
        showPostDetail = function(postId) {
            originalShowPostDetail(postId);
            setTimeout(() => {
                addConfigEvents(); // é‡æ–°ç»‘å®šé…ç½®äº‹ä»¶
            }, 350);
        };
        
        // ç”¨æˆ·ä¿¡æ¯æ‚¬æµ®çª—åŠŸèƒ½
        // è·Ÿè¸ªé¼ æ ‡ä½ç½®
    let currentMouseX = 0;
    let currentMouseY = 0;
    
    document.addEventListener('mousemove', function(e) {
        currentMouseX = e.clientX;
        currentMouseY = e.clientY;
    });
    


        // é…ç½®å•ä¿å­˜æˆåŠŸååˆ·æ–°é…ç½®å•åˆ—è¡¨
        function onConfigSaveSuccess() {
            loadUserConfigs();
        }
    </script>

    <!-- æ‚¬æµ®æ–°å»ºå¸–å­æŒ‰é’® -->
    <div class="floating-new-post-btn" onclick="window.location.href='/community/create'">
        <i class="fas fa-plus"></i>
        <span>æ–°å»ºå¸–å­</span>
    </div>

</body>
</html>
