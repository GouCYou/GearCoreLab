<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.gcc.gearcorelab.mapper.NotificationMapper">

    <!-- 根据用户名查询通知列表 -->
    <select id="findByUsername" resultType="cn.gcc.gearcorelab.model.Notification">
        SELECT
            n.id,
            n.user_id         AS userId,
            n.title,
            n.content,
            n.type,
            n.is_read         AS isRead,
            n.created_at      AS createdAt,
            n.read_at         AS readAt,
            n.sender_username AS senderUsername,
            n.sender_avatar_url AS senderAvatarUrl,
            n.related_post_id AS relatedPostId,
            n.related_comment_id AS relatedCommentId
        FROM notifications n
        INNER JOIN users u ON n.user_id = u.id
        WHERE u.username = #{username}
        ORDER BY n.created_at DESC
    </select>

    <!-- 根据ID查询通知 -->
    <select id="findById" resultType="cn.gcc.gearcorelab.model.Notification">
        SELECT
            n.id,
            n.user_id         AS userId,
            n.title,
            n.content,
            n.type,
            n.is_read         AS isRead,
            n.created_at      AS createdAt,
            n.read_at         AS readAt,
            n.sender_username AS senderUsername,
            n.sender_avatar_url AS senderAvatarUrl,
            n.related_post_id AS relatedPostId,
            n.related_comment_id AS relatedCommentId
        FROM notifications n
        WHERE n.id = #{id}
    </select>

    <!-- 统计用户未读通知数量 -->
    <select id="countUnreadByUsername" resultType="int">
        SELECT COUNT(*)
        FROM notifications n
        INNER JOIN users u ON n.user_id = u.id
        WHERE u.username = #{username} AND n.is_read = false
    </select>

    <!-- 插入新通知 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO notifications
            (user_id, title, content, type, is_read, created_at, sender_username, sender_avatar_url, related_post_id, related_comment_id)
        VALUES
            (#{userId}, #{title}, #{content}, #{type}, #{isRead}, #{createdAt}, #{senderUsername}, #{senderAvatarUrl}, #{relatedPostId}, #{relatedCommentId})
    </insert>

    <!-- 标记通知为已读 -->
    <update id="markAsRead">
        UPDATE notifications
        SET is_read = true, read_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- 标记用户所有通知为已读 -->
    <update id="markAllAsReadByUserId">
        UPDATE notifications
        SET is_read = true, read_at = NOW()
        WHERE user_id = #{userId} AND is_read = false
    </update>

    <!-- 删除通知 -->
    <delete id="delete">
        DELETE FROM notifications WHERE id = #{id}
    </delete>

    <!-- 获取所有通知（管理员用） -->
    <select id="findAll" resultType="cn.gcc.gearcorelab.model.Notification">
        SELECT
            n.id,
            n.user_id         AS userId,
            n.title,
            n.content,
            n.type,
            n.is_read         AS isRead,
            n.created_at      AS createdAt,
            n.read_at         AS readAt,
            n.sender_username AS senderUsername,
            n.sender_avatar_url AS senderAvatarUrl,
            n.related_post_id AS relatedPostId,
            n.related_comment_id AS relatedCommentId
        FROM notifications n
        ORDER BY n.created_at DESC
    </select>

    <!-- 根据ID删除通知（管理员用） -->
    <delete id="deleteById">
        DELETE FROM notifications WHERE id = #{id}
    </delete>

</mapper>